import {
  LayoutGrid,
  Columns,
  Rows,
  AlertTriangle,
  Zap,
  HardDrive,
  ChevronDown,
  Monitor,
} from "lucide-react";
import { useState, useMemo } from "react";
import { cn } from "@/lib/utils";
import {
  useLayoutConfigStore,
  usePerformanceModeStore,
  useScrollbackStore,
  useTerminalStore,
} from "@/store";
import { AUTO_ENABLE_THRESHOLD_MIN, AUTO_ENABLE_THRESHOLD_MAX } from "@/store/performanceModeStore";
import { appClient, terminalConfigClient } from "@/clients";
import type { TerminalLayoutStrategy, TerminalGridConfig, TerminalType } from "@/types";
import { getScrollbackForType, estimateMemoryUsage, formatBytes } from "@/utils/scrollbackConfig";

const STRATEGIES: Array<{
  id: TerminalLayoutStrategy;
  label: string;
  description: string;
  icon: typeof LayoutGrid;
}> = [
  {
    id: "automatic",
    label: "Automatic",
    description: "Smart Grid",
    icon: LayoutGrid,
  },
  {
    id: "fixed-columns",
    label: "Fixed Columns",
    description: "Vertical Scroll",
    icon: Columns,
  },
  {
    id: "fixed-rows",
    label: "Fixed Rows",
    description: "Horizontal Expand",
    icon: Rows,
  },
];

const SCROLLBACK_OPTIONS = [
  { value: 1000, label: "1,000 lines", description: "Low memory" },
  { value: 5000, label: "5,000 lines", description: "Balanced" },
  { value: 10000, label: "10,000 lines", description: "Full history" },
] as const;

const TYPICAL_TERMINAL_COUNTS: Partial<Record<TerminalType, number>> = {
  claude: 2,
  gemini: 2,
  codex: 2,
  shell: 6,
  npm: 2,
};

export function TerminalSettingsTab() {
  const layoutConfig = useLayoutConfigStore((state) => state.layoutConfig);
  const setLayoutConfig = useLayoutConfigStore((state) => state.setLayoutConfig);

  // Performance Mode Store
  const performanceMode = usePerformanceModeStore((state) => state.performanceMode);
  // const setPerformanceMode = usePerformanceModeStore((state) => state.setPerformanceMode); // Kept for consistency if needed, but enable/disable are better
  const autoEnabled = usePerformanceModeStore((state) => state.autoEnabled);
  const autoEnableThreshold = usePerformanceModeStore((state) => state.autoEnableThreshold);
  const enablePerformanceMode = usePerformanceModeStore((state) => state.enablePerformanceMode);
  const disablePerformanceMode = usePerformanceModeStore((state) => state.disablePerformanceMode);
  const setAutoEnableThreshold = usePerformanceModeStore((state) => state.setAutoEnableThreshold);

  // Terminal Store (for count)
  const terminalCount = useTerminalStore((state) => state.terminals.length);

  // Scrollback Store
  const scrollbackLines = useScrollbackStore((state) => state.scrollbackLines);
  const setScrollbackLines = useScrollbackStore((state) => state.setScrollbackLines);

  const [showMemoryDetails, setShowMemoryDetails] = useState(false);

  const memoryEstimate = useMemo(() => {
    return estimateMemoryUsage(TYPICAL_TERMINAL_COUNTS, scrollbackLines);
  }, [scrollbackLines]);

  const scrollbackLimits = useMemo(() => {
    const effectiveBase = performanceMode ? 100 : scrollbackLines;
    const types: Array<{ type: TerminalType; label: string }> = [
      { type: "claude", label: "Agent (Claude/Gemini/Codex/Custom)" },
      { type: "shell", label: "Shell" },
      { type: "npm", label: "Dev Server (npm/yarn/pnpm/bun)" },
    ];
    return types.map(({ type, label }) => ({
      label,
      limit: performanceMode ? 100 : getScrollbackForType(type, effectiveBase),
    }));
  }, [scrollbackLines, performanceMode]);

  const handleScrollbackChange = async (value: number) => {
    const previousValue = scrollbackLines;
    setScrollbackLines(value);
    try {
      await terminalConfigClient.setScrollback(value);
    } catch (error) {
      console.error("Failed to persist scrollback setting:", error);
      // Revert on failure
      setScrollbackLines(previousValue);
    }
  };

  const handleStrategyChange = (strategy: TerminalLayoutStrategy) => {
    const newConfig: TerminalGridConfig = { ...layoutConfig, strategy };
    setLayoutConfig(newConfig);
    appClient.setState({ terminalGridConfig: newConfig });
  };

  const handleValueChange = (val: string) => {
    const num = parseInt(val, 10);
    if (!isNaN(num) && num >= 1 && num <= 10) {
      const newConfig: TerminalGridConfig = { ...layoutConfig, value: num };
      setLayoutConfig(newConfig);
      appClient.setState({ terminalGridConfig: newConfig });
    }
  };

  const handlePerformanceModeToggle = async () => {
    const newValue = !performanceMode;
    try {
      await terminalConfigClient.setPerformanceMode(newValue);
      if (newValue) {
        enablePerformanceMode(false); // Manual enable
        document.body.setAttribute("data-performance-mode", "true");
      } else {
        disablePerformanceMode(); // Manual disable
        document.body.removeAttribute("data-performance-mode");
      }
    } catch (error) {
      console.error("Failed to persist performance mode setting:", error);
    }
  };

  const handleThresholdChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = parseInt(e.target.value, 10);
    if (!isNaN(value)) {
      setAutoEnableThreshold(value);
      try {
        await appClient.setState({ performanceModeAutoEnableThreshold: value });
      } catch (error) {
        console.error("Failed to persist auto-enable threshold:", error);
      }
    }
  };

  return (
    <div className="space-y-6">
      <div className="space-y-4">
        <div>
          <h4 className="text-sm font-medium text-canopy-text mb-2 flex items-center gap-2">
            <Zap className="w-4 h-4 text-amber-500" />
            Performance Mode
          </h4>
          <p className="text-xs text-canopy-text/50 mb-4">
            Optimize for high-density workflows. Reduces visual overhead for smoother performance
            with many active agents. Auto-enables at {autoEnableThreshold}+ terminals.
          </p>
        </div>

        <div className="flex items-center gap-2 p-3 rounded-lg bg-canopy-bg/50 border border-canopy-border">
          <Monitor className="w-4 h-4 text-canopy-text/50" />
          <span className="text-sm text-canopy-text/70">Active terminals:</span>
          <span
            className={cn(
              "text-sm font-medium",
              terminalCount >= autoEnableThreshold ? "text-amber-500" : "text-canopy-text"
            )}
          >
            {terminalCount}
          </span>
          <span className="text-sm text-canopy-text/50">/ {autoEnableThreshold} threshold</span>
        </div>

        <button
          onClick={handlePerformanceModeToggle}
          role="switch"
          aria-checked={performanceMode}
          aria-label="Performance Mode Toggle"
          className={cn(
            "w-full flex items-center justify-between p-4 rounded-lg border transition-all",
            performanceMode
              ? "bg-amber-500/10 border-amber-500 text-amber-500"
              : "border-canopy-border hover:bg-white/5 text-canopy-text/70"
          )}
        >
          <div className="flex items-center gap-3">
            <Zap
              className={cn("w-5 h-5", performanceMode ? "text-amber-500" : "text-canopy-text/50")}
            />
            <div className="text-left">
              <div className="text-sm font-medium">
                {performanceMode
                  ? autoEnabled
                    ? "Performance Mode (Auto-Enabled)"
                    : "Performance Mode Enabled"
                  : "Enable Performance Mode"}
              </div>
              <div className="text-xs opacity-70">
                {performanceMode
                  ? "100 line scrollback (viewport only), animations disabled"
                  : "1,000 line scrollback, animations enabled"}
              </div>
            </div>
          </div>
          <div
            className={cn(
              "w-11 h-6 rounded-full relative transition-colors",
              performanceMode ? "bg-amber-500" : "bg-canopy-border"
            )}
            aria-hidden="true"
          >
            <div
              className={cn(
                "absolute top-1 w-4 h-4 rounded-full bg-white transition-transform",
                performanceMode ? "translate-x-6" : "translate-x-1"
              )}
            />
          </div>
        </button>

        {performanceMode && (
          <p className="text-xs text-amber-500/80 flex items-center gap-1.5">
            <AlertTriangle className="w-3 h-3" />
            {autoEnabled
              ? `Auto-enabled at ${autoEnableThreshold} terminals. Toggle off to override, or adjust the threshold below.`
              : "New terminals will use reduced scrollback. Existing terminals are unchanged until respawned."}
          </p>
        )}

        <div className="space-y-2">
          <label htmlFor="threshold-input" className="text-sm text-canopy-text/70">
            Auto-Enable Threshold
          </label>
          <input
            id="threshold-input"
            type="number"
            min={AUTO_ENABLE_THRESHOLD_MIN}
            max={AUTO_ENABLE_THRESHOLD_MAX}
            value={autoEnableThreshold}
            onChange={handleThresholdChange}
            aria-describedby="threshold-help"
            className="bg-canopy-bg border border-canopy-border rounded px-3 py-2 text-canopy-text w-full focus:border-canopy-accent focus:outline-none transition-colors"
          />
          <p id="threshold-help" className="text-xs text-canopy-text/40">
            Performance mode auto-enables when terminal count reaches this threshold (
            {AUTO_ENABLE_THRESHOLD_MIN}-{AUTO_ENABLE_THRESHOLD_MAX}).
          </p>
        </div>
      </div>

      <div className="pt-4 border-t border-canopy-border space-y-4">
        <div>
          <h4 className="text-sm font-medium text-canopy-text mb-2 flex items-center gap-2">
            <HardDrive className="w-4 h-4 text-canopy-accent" />
            Scrollback History
          </h4>
          <p className="text-xs text-canopy-text/50 mb-4">
            Base scrollback applies to agent terminals. Shells and dev servers use reduced limits
            automatically.
          </p>
        </div>

        <div className="grid grid-cols-3 gap-2" role="radiogroup" aria-label="Scrollback presets">
          {SCROLLBACK_OPTIONS.map(({ value, label, description }) => (
            <button
              key={value}
              onClick={() => handleScrollbackChange(value)}
              disabled={performanceMode}
              role="radio"
              aria-checked={scrollbackLines === value}
              aria-label={`${label} - ${description}`}
              className={cn(
                "flex flex-col items-center justify-center p-3 rounded-md border transition-all",
                performanceMode && "opacity-50 cursor-not-allowed",
                scrollbackLines === value
                  ? "bg-canopy-accent/10 border-canopy-accent text-canopy-accent"
                  : "border-canopy-border hover:bg-white/5 text-canopy-text/70"
              )}
            >
              <span className="text-xs font-medium">{label}</span>
              <span className="text-[10px] mt-0.5 opacity-60">{description}</span>
            </button>
          ))}
        </div>

        <div className="text-xs text-canopy-text/50 space-y-1.5 bg-canopy-bg/50 rounded-md p-3">
          <div className="font-medium text-canopy-text/70 mb-2">
            Effective limits per type{performanceMode ? " (performance mode)" : ""}:
          </div>
          {scrollbackLimits.map(({ label, limit }) => (
            <div key={label} className="flex justify-between">
              <span>{label}</span>
              <span className="font-mono text-canopy-text/70">{limit.toLocaleString()} lines</span>
            </div>
          ))}
        </div>

        <button
          onClick={() => setShowMemoryDetails(!showMemoryDetails)}
          className="flex items-center gap-1.5 text-xs text-canopy-text/50 hover:text-canopy-text/70 transition-colors"
          aria-expanded={showMemoryDetails}
          aria-controls="memory-details"
        >
          <ChevronDown
            className={cn("w-3 h-3 transition-transform", showMemoryDetails && "rotate-180")}
          />
          <span>Estimated memory usage</span>
        </button>

        {showMemoryDetails && (
          <div
            id="memory-details"
            className="text-xs text-canopy-text/50 space-y-1.5 bg-canopy-bg/50 rounded-md p-3"
          >
            <div className="font-medium text-canopy-text/70 mb-2">
              Typical session (6 agents, 6 shells, 2 dev servers):
            </div>
            <div className="flex justify-between">
              <span>Agent terminals (6)</span>
              <span className="font-mono text-canopy-text/70">
                {formatBytes(
                  (memoryEstimate.perType.claude ?? 0) +
                    (memoryEstimate.perType.gemini ?? 0) +
                    (memoryEstimate.perType.codex ?? 0)
                )}
              </span>
            </div>
            <div className="flex justify-between">
              <span>Shell terminals (6)</span>
              <span className="font-mono text-canopy-text/70">
                {formatBytes(memoryEstimate.perType.shell ?? 0)}
              </span>
            </div>
            <div className="flex justify-between">
              <span>Dev servers (2)</span>
              <span className="font-mono text-canopy-text/70">
                {formatBytes(memoryEstimate.perType.npm ?? 0)}
              </span>
            </div>
            <div className="flex justify-between pt-1.5 border-t border-canopy-border mt-1.5">
              <span className="font-medium text-canopy-text/70">Total estimated</span>
              <span className="font-mono font-medium text-canopy-accent">
                {formatBytes(memoryEstimate.total)}
              </span>
            </div>
          </div>
        )}
      </div>

      <div className="pt-4 border-t border-canopy-border">
        <h4 className="text-sm font-medium text-canopy-text mb-2">Grid Layout Strategy</h4>
        <p className="text-xs text-canopy-text/50 mb-4">
          Control how terminals arrange in the grid as you add more.
        </p>
      </div>

      <div className="grid grid-cols-3 gap-3">
        {STRATEGIES.map(({ id, label, description, icon: Icon }) => (
          <button
            key={id}
            onClick={() => handleStrategyChange(id)}
            className={cn(
              "flex flex-col items-center justify-center p-4 rounded-md border transition-all",
              layoutConfig.strategy === id
                ? "bg-canopy-accent/10 border-canopy-accent text-canopy-accent"
                : "border-canopy-border hover:bg-white/5 text-canopy-text/70"
            )}
          >
            <Icon className="w-6 h-6 mb-2" />
            <span className="text-xs font-medium">{label}</span>
            <span className="text-[10px] text-center mt-1 opacity-60">{description}</span>
          </button>
        ))}
      </div>

      {layoutConfig.strategy !== "automatic" && (
        <div className="space-y-2">
          <label className="text-sm text-canopy-text/70">
            {layoutConfig.strategy === "fixed-columns" ? "Number of Columns" : "Number of Rows"}
          </label>
          <input
            type="number"
            min="1"
            max="10"
            value={layoutConfig.value}
            onChange={(e) => handleValueChange(e.target.value)}
            className="bg-canopy-bg border border-canopy-border rounded px-3 py-2 text-canopy-text w-full focus:border-canopy-accent focus:outline-none transition-colors"
          />
          <p className="text-xs text-canopy-text/40">
            {layoutConfig.strategy === "fixed-columns"
              ? "Terminals will stack vertically when this many columns are filled."
              : "Terminals will expand horizontally when this many rows are filled."}
          </p>
        </div>
      )}

      <div className="pt-4 border-t border-canopy-border">
        <h5 className="text-xs font-medium text-canopy-text mb-2">Current Strategy</h5>
        <p className="text-xs text-canopy-text/50 leading-relaxed">
          {layoutConfig.strategy === "automatic" &&
            "Uses a balanced square grid that adapts to the number of terminals (1-4 terminals use 2 columns, 5+ use up to 4 columns)."}
          {layoutConfig.strategy === "fixed-columns" &&
            `Maintains exactly ${layoutConfig.value} column${layoutConfig.value > 1 ? "s" : ""}, adding new rows as you open more terminals.`}
          {layoutConfig.strategy === "fixed-rows" &&
            `Maintains exactly ${layoutConfig.value} row${layoutConfig.value > 1 ? "s" : ""}, adding new columns as you open more terminals.`}
        </p>
      </div>
    </div>
  );
}
