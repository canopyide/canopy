description = "Create worktree and start working on a GitHub issue (Canopy workflow)"
prompt = '''
**FULLY AUTONOMOUS EXECUTION - Canopy Project**

**Issue Reference:** {{args}}

**Goal:** Work autonomously to completion - PR created.

**Principles (from github-orchestration):**
- **Fix, don't ask:** If `npm run check` or `npm run test` fails, fix it.
- **Commit continuously:** Use conventional commits.
- **Worktrees:** Use a separate worktree for isolation. NEVER modify the main worktree.
- **Dependencies:** Use `npm install` and `npm run rebuild` for native modules.

### Step 1: Parse and Fetch Issue

1. Extract issue number from `{{args}}`.
2. Fetch issue details: `run_shell_command("gh issue view {number} --json title,body,number", description="Fetch GitHub issue details")`.
3. Assign to self: `run_shell_command("gh issue edit {number} --add-assignee @me", description="Assign issue to self on GitHub")`.

### Step 2: Create Worktree

1. **Branch Name**: Determine based on issue title and type (e.g., `feature/issue-{number}-{short-desc}`, `fix/issue-{number}-{short-desc}`).
2. **Worktree Path**: `../canopy-issue-{number}`.
3. **Base Branch**: Use `main` (Canopy's default).
4. **Command**: `run_shell_command("git worktree add -b <branch-name> <worktree-path> origin/main", description="Create a new git worktree for the issue")`.

### Step 3: Setup Environment in Worktree

1. **Enter Worktree**: `run_shell_command("cd <worktree-path>", description="Change directory to the new worktree")`.
2. **Install Dependencies**: `run_shell_command("npm install", description="Install Node.js dependencies for the Canopy project")`.
3. **Rebuild Native Modules**: `run_shell_command("npm run rebuild", description="Rebuild native modules like node-pty for Electron compatibility")`.

### Step 4: Codex Plan (Implementation Guidance)

**CRITICAL:** This step runs AUTOMATICALLY.

1. **Check for Existing Guidance**: Review issue comments for detailed instructions.
2. **Consult Codex**: If no detailed instructions exist, ask Codex for an implementation plan.
   - Command: `run_shell_command("claude -p \"Analyze issue #{number} and provide a structured implementation plan including technical analysis, code mapping, and testing strategy. Current directory: $(pwd)\"")`
3. **Internalize Plan**: Use this plan as your roadmap. Do not pause for user approval.

### Step 5: Implement (Autonomous with Codex)

**Loop until done:**

**Principles:**
- **Pair Program with Codex**: If uncertain (edge cases, APIs, patterns), ask Codex via `run_shell_command("claude -p \"<question>\"")`.
- **Fix, don't ask**: Fix lint/test errors immediately.

1. **Implement Changes**: Use `write_file` and `replace` to apply code changes based on the plan.
2. **Iterative Verification**:
   - **Full Quality Check**: `run_shell_command("npm run check", description="Run Canopy's linting, type-checking, and format checks")`.
   - **Run Tests**: `run_shell_command("npm run test", description="Run Canopy's unit tests using Vitest")`.
   - **Fix Failures**: Immediately identify and fix any errors. Use `codebase_investigator` or ask Codex.
3. **Commit Regularly**:
   - `run_shell_command("git add -A", description="Stage all changes for commit")`.
   - `run_shell_command("git commit -m '<conventional-commit-message>'", description="Commit changes with a conventional message")`.

### Step 6: Codex Implementation Review

**Mandatory Review:**

1. **Request Review**: Ask Codex to review the implementation.
   - Command: `run_shell_command("claude -p \"Review the implementation for issue #{number} in the current directory. Check for logic errors, edge cases, missing tests, and adherence to project patterns. List specific fixes required.\"")`
2. **Apply Fixes**: If issues are found, fix them immediately (repeat Step 5 logic) until the review is clean.

### Step 7: Create Pull Request

**Mandatory Final Step:**

1. **Push Branch**: `run_shell_command("git push -u origin HEAD", description="Push the feature branch to origin")`.
2. **Create PR**: `run_shell_command("gh pr create --title '<PR Title>' --body 'Closes #{number}'", description="Create a new GitHub pull request")`.
3. **Report**: Display the URL of the created PR.

**Worktree Cleanup**: Remind the user that the worktree is still available at `<worktree-path>` and should be removed with `git worktree remove <path>` when completely done.
'''
