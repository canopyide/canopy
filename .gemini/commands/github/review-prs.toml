description = "Review, test, and merge all open pull requests in a batch operation."
prompt = """
## Instructions for Gemini

**Arguments:** {{args}}

**CRITICAL: BIAS TOWARDS ACTION**

This command is **fully automated**. Your job is to merge as many PRs as possible with minimal hesitation. You are acting as both the automation engineer and the expert reviewer.

- **DO NOT** ask for confirmation before merging.
- **DO NOT** wait unnecessarily ‚Äî if CI is running, proceed and fix issues post-merge.
- **DO NOT** over-analyze mechanical fixes ‚Äî make decisions quickly.
- **DO** fix issues yourself instead of deferring to the user.
- **DO** continue to the next PR if one fails ‚Äî never stop the batch.
- **DO NOT** run tests on the feature branch. Only run tests **AFTER** merging into the target branch.

**Default stance:** Act first, report results at the end. The user wants PRs merged, not status updates.

---

Review, test, and merge all open pull requests in a logical order based on dependencies, file conflicts, priority, and age.

**This is a batch operation** that processes multiple PRs sequentially using an optimized workflow that works directly in the main repository.

### Step 0: Plan & Setup

1.  **Worktree Cleanup:** Worktrees are deleted on-demand in Step 2.2.
2.  **Environment Check:**
    *   Check current location: `pwd`
    *   Record current branch: `git branch --show-current`
    *   Check status: `git status --short`
    *   **If dirty:** Stash changes: `git stash push -u -m "review-all-prs-autostash"` and record this for restoration later.
    *   **If not on main/master/develop:** Warn but continue.

### Step 1: Fetch & Analyze PRs

1.  **Fetch Open PRs:**
    Use `gh pr list --state open --json number,title,headRefName,baseRefName,labels,createdAt,updatedAt,isDraft,author` to get the list.
    *   If no PRs, exit.

2.  **Analyze Files:**
    For each PR, identify modified files: `gh pr diff {number} --name-only`.

3.  **Determine Merge Order:**
    Analyze PRs and create a sorted list based on:
    *   **Exclude Drafts.**
    *   **Priority Labels:** (P1 > P2 > P3).
    *   **Base Branch:** (hotfix > bugfix > main/master > develop).
    *   **Dependencies:** (PRs blocking others must go first).
    *   **File Conflicts:** (Group conflicting PRs, merge oldest first).
    *   **Size & Age:** (Smallest and Oldest preferred as tiebreakers).

4.  **Display Order:**
    Print the proposed merge order clearly. **Proceed immediately.**

### Step 2: Sequential Review & Merge Loop

For each PR in the calculated order:

#### 2.1: Context & Setup
*   **Log:** `üîÑ Processing PR #{number}: {title}`
*   **Fetch Details:** Get comments and reviews using `gh pr view` and `gh api` (specifically looking for automated feedback).
*   **Context Check:**
    *   Does this PR conflict with changes *already merged in this session*?
    *   If yes, use `read_file` to understand the integration points.
    *   Adapt the PR code using `replace` if necessary to fit the new state.

#### 2.2: Delete Worktree (CRITICAL)
*   **Identify Worktree:** Check if a git worktree exists for the PR branch: `git worktree list`.
*   **DELETE IT:** If found, remove it immediately: `git worktree remove --force {path}`.
*   **Verify:** Ensure the worktree is gone. The merge **MUST** happen in the main directory.

#### 2.3: Checkout PR Branch (For Review Only)
*   **Fetch & Checkout:** `git fetch origin` -> `git checkout {headRefName}` -> `git pull origin {headRefName}`.
*   **Address Feedback:**
    *   Scan comments for P1/P2 priority.
    *   Fix issues using `replace` or `write_file`.
    *   Commit fixes: `git commit -am "fix: address review feedback"`
*   **DO NOT** merge `main` into the feature branch here.
*   **DO NOT REBASE** unless absolutely necessary for conflict resolution. Rebasing changes commit hashes and breaks the link between the PR and the merge, preventing GitHub from auto-closing linked issues.
*   **DO NOT** run tests here.

#### 2.4: Merge into Target
*   **Identify Target:** Default to current branch, or `develop`/`main` if Gitflow is detected (based on PR baseRefName).
*   **Checkout Target:** `git checkout {target_branch}`.
*   **Pull Target:** `git pull origin {target_branch}`.
*   **Execute Merge:** `git merge --no-ff {headRefName} -m "Merge pull request #{number}: {title}"`
*   **Handle Conflicts:**
    *   **Simple (lockfiles, whitespace):** Resolve automatically (e.g., `checkout --theirs package-lock.json`).
    *   **Complex:** Use `read_file` to inspect markers (`<<<<<<<`). Use your **Expert Judgment** to resolve. If you cannot resolve it safely, abort the merge (`git merge --abort`) and mark PR as FAILED.
*   **Cleanup Artifacts:**
    *   Grep for `<<<<<<<`, `=======`. If found, fix them immediately.

#### 2.5: Post-Merge Verification (CRITICAL)
**Run tests/lint/format ONLY HERE (after merge).**
1.  **Run Checks:** Detect and run:
    *   Tests (e.g., `npm test`, `cargo test`)
    *   Lint (e.g., `npm run lint` or `npm run check`)
    *   Format (e.g., `npm run format`)
2.  **Fix Loop (Max 3 attempts):**
    *   If failure: Analyze output -> Fix code -> Re-run.
    *   If still failing after 3 attempts: **Abort.** `git reset --hard origin/{target-branch}`. Mark PR as FAILED.
3.  **Commit Fixes:** If changes were made, `git commit -am "chore: post-merge fixes"`.

#### 2.6: Finalize
*   **Push:** `git push origin {target-branch}`
*   **Verify Issues Closed:**
    *   Check if the PR description closes any issues (look for 'Closes #123', 'Fixes #123').
    *   If yes, verify the issue is closed: `gh issue view {issue_number} --json state`.
    *   If open, close it manually: `gh issue close {issue_number} --comment "Fixed via manual merge of PR #{number}"`.
*   **Close PR:** `gh pr close {number}` (if not auto-closed).
*   **Delete Branch:** `git push origin --delete {headRefName}` && `git branch -D {headRefName}`.
*   **Update Session Context:** Record what was merged to inform the next PRs.
*   **Return:** `git checkout {starting-branch}`.

### Step 3: Final Report

After all PRs are processed:
1.  Restore original state (pop stash if created).
2.  Display Summary:
    *   ‚úÖ Merged: [List]
    *   ‚ùå Failed: [List with reasons]
    *   ‚è≠Ô∏è Skipped: [Drafts]

**Reminder:** You are an expert engineer. Trust your judgment. Bias for action. Speed is key.
"""
