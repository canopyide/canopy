description = "Review, test, and merge all open pull requests in a batch operation."
prompt = """
## Instructions for Gemini

**Arguments:** {{args}}

**CRITICAL: BIAS TOWARDS ACTION**

This command is **fully automated**. Your job is to merge as many PRs as possible with minimal hesitation. You are acting as both the automation engineer and the expert reviewer.

- **DO NOT** ask for confirmation before merging.
- **DO NOT** wait unnecessarily.
- **DO NOT** over-analyze mechanical fixes ‚Äî make decisions quickly.
- **DO NOT** run tests, linting, or formatting during the merge loop ‚Äî only at the very end.
- **DO** fix issues yourself instead of deferring to the user.
- **DO** continue to the next PR if one fails ‚Äî never stop the batch.

**Default stance:** Merge everything first, fix quality issues once at the end. The user wants PRs merged, not status updates.

---

Review and merge all open pull requests in a logical order. Quality checks run once after all merges are complete.

**This is a batch operation** that processes multiple PRs sequentially using an optimized workflow that works directly in the main repository.

### Step 0: Setup

1.  **Enable `git rerere`:** `git config rerere.enabled true && git config rerere.autoupdate true`. This makes Git remember conflict resolutions and auto-apply them if the same conflict recurs in later PRs.
2.  **Environment Check:**
    *   Record current branch: `git branch --show-current`
    *   Check status: `git status --short`
    *   **If dirty:** `git stash push -u -m "review-all-prs-autostash"` and record for restoration later.
    *   **If not on main/master/develop:** Warn but continue.

### Step 1: Fetch & Plan Merge Order

1.  **Fetch Open PRs:**
    `gh pr list --state open --json number,title,headRefName,baseRefName,labels,createdAt,updatedAt,isDraft,author`
    *   If no PRs, exit.

2.  **Analyze Files:**
    For each PR: `gh pr diff {number} --name-only`.

3.  **Determine Merge Order** using these criteria (highest priority first):
    *   **Exclude Drafts.**
    *   **Topological / Dependency order:** Infrastructure and config changes first, then shared/API layers, then business logic, then UI. PRs that are depended on by others must merge first.
    *   **Priority Labels:** (P1 > P2 > P3).
    *   **Base Branch:** (hotfix > bugfix > main/master > develop).
    *   **File Conflicts:** Group conflicting PRs together, merge oldest first to establish the baseline.
    *   **Size & Age:** Smallest and oldest as tiebreakers ‚Äî clearing small PRs first reduces queue size quickly.

4.  **Display Order:** Print the proposed merge order. **Proceed immediately.**

### Step 2: Merge Loop

For each PR in the calculated order:

#### 2.1: Review
*   **Log:** `üîÑ Processing PR #{number}: {title}`
*   **Fetch Context:**
    *   `gh pr view {number} --json body,title,url,comments,reviews`
    *   **Identify Linked Issue:** Scan for "Closes #X" or "Fixes #Y".
    *   If found, `gh issue view {issue_number} --json body,title`.
*   **Code Review:**
    *   Use `gh pr diff {number}` to analyze the changes.
    *   **Reject only for MAJOR flaws** (wrong architecture, missing core logic). Comment on PR and skip.
    *   Minor issues (bugs, typos, edge cases) ‚Äî note for fixing before merge.

#### 2.2: Prepare Branch
*   **Delete Worktree:** If `git worktree list` shows one for this branch, remove it: `git worktree remove --force {path}`.
*   **Fetch & Checkout:** `git fetch origin` -> `git checkout {headRefName}` -> `git pull origin {headRefName}`.
*   **Apply Fixes:** If the review noted minor issues or PR comments need addressing, fix them now.
*   **Commit Fixes:** `git commit -am "fix: address review feedback"` (only if changes were made).
*   **DO NOT** merge target into the feature branch. **DO NOT REBASE.**

#### 2.3: Merge into Target
*   **Checkout Target:** `git checkout {target_branch}` -> `git pull origin {target_branch}`.
*   **Execute Merge:** `git merge --no-ff {headRefName} -m "Merge pull request #{number}: {title}"`
*   **Handle Conflicts:**
    *   **Check `git rerere` first** ‚Äî it may have auto-resolved from a previous conflict in this batch.
    *   **Lockfiles (`package-lock.json`, etc.):** `git checkout --theirs {file}` then regenerate later in Step 3.
    *   **Simple (whitespace, imports):** Resolve automatically.
    *   **Complex:** Inspect conflict markers with `read_file`. Use expert judgment. If unresolvable, `git merge --abort` and mark as FAILED.
*   **Verify:** Grep for `<<<<<<<` or `=======`. If found, fix immediately.
*   **DO NOT push yet.** Continue to the next PR.

#### 2.4: Cleanup PR
*   **Close PR:** `gh pr close {number}` (if not auto-closed by merge).
*   **Close Linked Issues:** If PR references "Closes #X" / "Fixes #X", check with `gh issue view {issue_number} --json state`. If still open: `gh issue close {issue_number} --comment "Fixed via merge of PR #{number}"`.
*   **Delete Remote Branch:** `git push origin --delete {headRefName}`.
*   **Delete Local Branch:** `git branch -D {headRefName}`.
*   **Return to target:** `git checkout {target_branch}`.

### Step 3: Post-Merge Quality Pass (ONE TIME)

After **all** PRs have been merged (or attempted):

1.  **Install Dependencies:** `npm install` (dependencies may have changed across PRs ‚Äî this also regenerates `package-lock.json` if lockfile conflicts were resolved with `--theirs`).
2.  **Rebuild Native Modules:** `npm run rebuild` (crucial for `node-pty`).
3.  **Run Quality Checks:** `npm run check` (linting, type-checking, formatting).
4.  **Run Tests:** `npm run test` (Vitest).
5.  **Fix Loop (Max 3 attempts):**
    *   If failure: Analyze output -> Fix code -> Re-run checks/tests.
    *   If still failing after 3 attempts: Stop fixing and report the failures.
6.  **Commit & Push:** If ANY changes were made (formatting, lint fixes, type fixes, lockfile regeneration): `git commit -am "chore: post-merge fixes"` -> `git push origin {target_branch}`.

### Step 4: Final Report

1.  Restore original state (pop stash if created).
2.  Display a single list of all processed PRs with status emojis:
    *   Format: `{emoji} PR #{number}: {title}`
    *   ‚úÖ = Successfully merged
    *   ‚ùå = Failed (include brief reason in parentheses)
    *   ‚è≠Ô∏è = Skipped (draft)

    **Do NOT use separate headers like "Merged:", "Failed:", "Skipped:".** Just show one unified list.
    Only show the emoji legend if there are mixed results.

**Reminder:** You are an expert engineer. Trust your judgment. Bias for action. Speed is key.
"""
